<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Panel - Advanced</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- CSS GENERAL --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { display: flex; background-color: #121212; color: #e0e0e0; height: 100vh; overflow: hidden; }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00ff88; }

        /* --- LOADING SCREEN (FIX PENTRU FLICKER) --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 10000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .loader {
            border: 4px solid #333; border-top: 4px solid #00ff88;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- MODERN SWEETALERT DARK THEME (ADAUGAT) --- */
        .swal2-popup {
            background: rgba(15, 15, 15, 0.95) !important;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 255, 136, 0.2) !important;
            color: #fff !important;
            border-radius: 25px !important;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8) !important;
        }
        .swal2-title { color: #fff !important; font-weight: 800 !important; text-transform: uppercase; letter-spacing: 1px; }
        .swal2-html-container { color: #ccc !important; }
        .swal2-confirm { background: #00ff88 !important; color: #000 !important; font-weight: bold !important; border-radius: 12px !important; padding: 12px 30px !important; }
        .swal2-timer-progress-bar { background: #00ff88 !important; }

        /* --- OVERLAY VERIFICARE --- */
        #verify-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #000000; z-index: 99999; display: none;
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .verify-box {
            border: 1px solid #333; padding: 40px; border-radius: 20px; background: #0a0a0a;
            box-shadow: 0 0 50px rgba(0, 255, 136, 0.1); max-width: 500px; width: 90%;
        }
        .code-display {
            font-size: 32px; letter-spacing: 2px; color: #00ff88; font-weight: bold; font-family: monospace;
            margin: 25px 0; border: 2px dashed #00ff88; padding: 15px; border-radius: 10px;
            background: rgba(0, 255, 136, 0.05); user-select: all;
        }

        /* --- LOGIN STYLES --- */
        /* Nota: Default display none ca sa nu apara flicker */
        /* --- UPGRADE LOGIN MODERN (Glassmorphism) --- */
        /* Container Video */
        .video-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; overflow: hidden; }
        .video-background iframe {
            /* √él facem de 2 ori mai mare dec√¢t ecranul »ôi √Æl mic»ôorƒÉm la loc cu scale */
            /* Asta for»õeazƒÉ YouTube sƒÉ trimitƒÉ stream-ul de rezolu»õie maximƒÉ */
            width: 200%; 
            height: 200%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.6); /* Scale 0.6 √Æl aduce la mƒÉrimea ecranului tƒÉu */
            pointer-events: none;
            filter: brightness(0.8) contrast(1.1); /* √éi dƒÉm »ôi pu»õin "pop" vizual */
        }
        .video-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.8) 100%); z-index: 0; }

        /* Center Login Panel */
        #auth-container {
            background: transparent !important;
            display: none; /* Se activeaza din JS */
            justify-content: center;
            align-items: center;
        }

        .auth-box {
            position: relative;
            background: rgba(10, 10, 10, 0.85) !important; /* Aproape negru, foarte pro */
            backdrop-filter: blur(25px) saturate(180%);
            padding: 60px 45px;
            border-radius: 30px;
            border: 1px solid rgba(0, 255, 136, 0.2); /* Margine verde foarte fina */
            width: 420px;
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.9);
            transition: 0.5s ease;
        }

        .auth-box:hover {
            border-color: rgba(0, 255, 136, 0.6);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.1);
        }

        .auth-box h2 {
            font-size: 32px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 5px;
            background: linear-gradient(to right, #fff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 35px;
        }

        .auth-box input {
            background: rgba(255, 255, 255, 0.03) !important;
            color: #ffffff !important; /* Textul pe care √Æl scrii va fi alb */
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            padding: 18px !important;
            border-radius: 15px !important;
            margin-bottom: 20px !important;
            font-size: 16px !important;
            transition: 0.3s;
        }

        .auth-box input:focus {
            background: rgba(0, 255, 136, 0.05) !important;
            border-color: #00ff88 !important;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.1);
        }

        .btn-auth {
            background: #00ff88 !important;
            color: #000 !important;
            padding: 20px !important;
            border-radius: 15px !important;
            font-size: 16px !important;
            font-weight: 900 !important;
            letter-spacing: 2px !important;
            margin-top: 25px !important;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
        }

        .btn-auth:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 15px 30px rgba(0, 255, 136, 0.4) !important;
        }
        .switch-auth { margin-top: 15px; font-size: 12px; cursor: pointer; color: #aaa; text-decoration: underline; }

        /* --- DASHBOARD CONTAINER --- */
        /* Nota: Default display none ca sa nu apara flicker */
        #dashboard-container { display: none; width: 100%; height: 100%; display: flex; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px; background-color: #1a1a1a; display: flex; flex-direction: column;
            padding: 25px; border-right: 1px solid #2a2a2a; box-shadow: 4px 0 15px rgba(0,0,0,0.3); z-index: 10;
        }
        .logo { margin-bottom: 40px; text-align: center; padding-bottom: 20px; border-bottom: 1px solid #333; }
        .logo h2 { color: #fff; font-weight: 800; letter-spacing: 1px; }
        .logo span { color: #00ff88; }
        .sidebar ul { list-style: none; }
        .sidebar ul li { margin-bottom: 10px; }
        .sidebar ul li a {
            text-decoration: none; color: #aaa; font-size: 15px; display: flex; align-items: center;
            padding: 12px 15px; border-radius: 8px; transition: all 0.2s ease; cursor: pointer;
        }
        .sidebar ul li a i { margin-right: 15px; width: 20px; text-align: center; }
        .sidebar ul li a:hover, .sidebar ul li.active a {
            background-color: rgba(0, 255, 136, 0.1); color: #00ff88; font-weight: 600; border-left: 3px solid #00ff88;
        }
        .logout { margin-top: auto; }
        .logout a { color: #ff4d4d !important; }
        .logout a:hover { background: rgba(255, 77, 77, 0.1) !important; }

        /* --- MAIN CONTENT AREA --- */
        .main-content {
            flex: 1; padding: 40px; overflow-y: auto;
            background: #141414; /* Flat dark bg for cleaner look */
        }

        /* --- HEADER COMUN --- */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .search-box {
            background: #1f1f1f; padding: 8px 15px; border-radius: 8px;
            display: flex; align-items: center; border: 1px solid #333; width: 300px;
        }
        .search-box input { background: transparent; border: none; color: #fff; margin-left: 10px; outline: none; width: 100%; }
        .user-mini-profile { display: flex; align-items: center; gap: 12px; }
        .user-mini-profile img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #333; }

        /* --- PAGES --- */
        .page-section { display: none; animation: fadeIn 0.3s ease; }
        .page-section.active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- STATS GRID --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card {
            background-color: #1f1f1f; padding: 20px; border-radius: 12px; position: relative;
            border: 1px solid #2a2a2a; transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-3px); border-color: #00ff88; }
        .card i { font-size: 24px; margin-bottom: 10px; color: #00ff88; background: rgba(0,255,136,0.1); padding: 8px; border-radius: 8px; }
        .card h3 { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .card p { font-size: 22px; font-weight: 700; color: #fff; }

        /* --- PROFILE --- */
        .profile-layout { display: flex; flex-direction: column; gap: 30px; }
        .profile-header-card {
            background: #1f1f1f; border-radius: 12px; padding: 30px; border: 1px solid #2a2a2a;
            display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 20px;
        }
        .big-avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid #00ff88; margin-bottom: 15px; }
        .profile-name { font-size: 24px; font-weight: bold; color: #fff; }
        .profile-status { font-size: 14px; color: #00ff88; display: flex; align-items: center; gap: 5px; margin-bottom: 15px; }
        .status-dot { width: 8px; height: 8px; background: #00ff88; border-radius: 50%; display: inline-block; }
        
        .badges-container { display: flex; gap: 10px; justify-content: center; }
        .badge { padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; color: #fff; }
        .badge-vip { background: linear-gradient(45deg, #f1c40f, #f39c12); color: #000; }

        /* --- TABS --- */
        .profile-tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .tab-btn { color: #888; cursor: pointer; padding: 10px; font-weight: 500; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active-tab { color: #00ff88; border-bottom: 2px solid #00ff88; }

        /* --- DATA ROWS --- */
        .data-row {
            display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #2a2a2a;
            font-size: 14px;
        }
        .data-row:last-child { border-bottom: none; }
        .data-label { color: #888; font-weight: 500; }
        .data-value { color: #fff; font-weight: 600; }

        /* --- CAR TABLE --- */
        .vehicles-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .vehicles-table th { text-align: left; color: #888; padding: 10px; border-bottom: 1px solid #333; font-size: 12px; text-transform: uppercase; }
        .vehicles-table td { padding: 15px 10px; border-bottom: 1px solid #2a2a2a; color: #fff; font-size: 14px; }
        .vehicle-status-ok { color: #00ff88; } .vehicle-status-broken { color: #ff4d4d; }

        .tab-content { display: none; } .tab-content.active-tab-content { display: block; }

        /* Warning Email */
        .email-warning {
            background: rgba(255, 77, 77, 0.1); border: 1px solid #ff4d4d; color: #ff4d4d;
            padding: 12px 20px; border-radius: 8px; margin-bottom: 30px; display: none; align-items: center; justify-content: space-between;
        }

        @media (max-width: 900px) { .profile-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="video-background">
    <div class="video-overlay"></div>
    <iframe src="https://www.youtube.com/embed/BiOPO-nKj7s?autoplay=1&mute=1&controls=0&loop=1&playlist=BiOPO-nKj7s&showinfo=0&rel=0&modestbranding=1&iv_load_policy=3&start=10&disablekb=1&fs=0&origin=http://localhost" 
        frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div>

    <div id="loading-screen">
        <div class="loader"></div>
        <h3 style="color:white; letter-spacing: 2px;">SEVID<span style="color:#00ff88">STUDIOS</span></h3>
    </div>

    <div id="verify-overlay">
        <div class="verify-box">
            <h1 style="color:white; font-size: 28px; margin-bottom: 10px;">‚ö†Ô∏è Cont Neverificat</h1>
            <p style="color:#ccc; font-size: 16px; margin-bottom: 20px;">
                Trebuie sƒÉ confirmi cƒÉ e»ôti proprietarul contului <b><span id="verify-name" style="color: #00ff88;"></span></b>.
            </p>
            <p style="color:#888; margin-bottom: 5px;">IntrƒÉ pe server »ôi scrie √Æn chat:</p>
            <div class="code-display" id="verification-code">Generare cod...</div>
            <p style="color:#666; font-size: 12px; margin-top: 20px;">(DacƒÉ scrii corect, acest ecran dispare singur)</p>
            <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                <button onclick="activeazaVerificarea()" style="background: #333; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 5px;">üîÑ GenereazƒÉ Cod Nou</button>
                <button onclick="logoutUser()" style="background: transparent; border: 1px solid #444; color: #aaa; padding: 10px 15px; cursor: pointer; border-radius: 5px;">Ie»ôire</button>
            </div>
        </div>
    </div>

    <div id="auth-container">
        <div class="auth-box" id="login-form">
            <h2>üîê Login Panel</h2>
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-pass" placeholder="ParolƒÉ">
            <button class="btn-auth" onclick="loginUser()">IntrƒÉ √Æn cont</button>
            <p class="switch-auth" onclick="toggleForms()">Nu ai cont? √énregistreazƒÉ-te</p>
        </div>
        <div class="auth-box" id="register-form" style="display: none;">
            <h2>üìù √énregistrare</h2>
            <input type="text" id="reg-roblox" placeholder="Nume Exact Roblox (ex: sbyk)">
            <input type="email" id="reg-email" placeholder="Email">
            <input type="password" id="reg-pass" placeholder="ParolƒÉ">
            <button class="btn-auth" onclick="registerUser()">CreeazƒÉ Cont</button>
            <p class="switch-auth" onclick="toggleForms()">Ai deja cont? LogheazƒÉ-te</p>
        </div>
    </div>

    <div id="dashboard-container">
        <div class="sidebar">
            <div class="logo"><h2>SEVID<span>STUDIOS</span></h2></div>
            <ul>
                <li id="nav-dashboard" onclick="navigateTo('/dashboard')">
                    <a><i class="fas fa-chart-line"></i> Dashboard</a>
                </li>
                <li id="nav-profile" onclick="navigateTo('/profile')">
                    <a><i class="fas fa-user-circle"></i> Profilul Meu</a>
                </li>
                <li><a><i class="fas fa-users"></i> Fac»õiuni</a></li>
                <li><a><i class="fas fa-file-contract"></i> Reclama»õii</a></li>
                <li><a><i class="fas fa-store"></i> Shop Premium</a></li>
            </ul>
            <div class="logout"><a onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> Ie»ôire</a></div>
        </div>

        <div class="main-content">
            <div id="email-alert" class="email-warning">
                <div><i class="fas fa-exclamation-triangle"></i> Emailul <b><span id="alert-email-addr"></span></b> nu este confirmat!</div>
                <button onclick="resendVerification()" style="background:none; border:none; color:#fff; text-decoration:underline; cursor:pointer;">Retrimite Email</button>
            </div>

            <header>
                <div class="welcome-text">
                    <h1 id="page-title">Dashboard</h1>
                    <p style="color:#666; font-size:14px;">Bine ai venit pe panel!</p>
                </div>
                <div class="user-mini-profile">
                    <div class="search-box">
                        <i class="fas fa-search" style="color:#666"></i>
                        <input type="text" id="searchInput" placeholder="CautƒÉ jucƒÉtor...">
                        <i class="fas fa-arrow-right" style="color:#00ff88; cursor:pointer;" onclick="cautaJucatorManual()"></i>
                    </div>
                    <img src="https://tr.rbxcdn.com/535451733604f3780376d54833215904/150/150/AvatarHeadshot/Png" id="miniAvatar">
                </div>
            </header>

            <div id="page-dashboard" class="page-section">
                <div class="profile-header-card" style="align-items: flex-start; text-align: left; padding: 20px;">
                    <h3 style="color:#fff; margin-bottom: 15px; border-bottom: 1px solid #333; width:100%; padding-bottom:10px;">Jurnal Activitate</h3>
                    <div style="width:100%; color:#888; font-size:14px;">
                        <p><i class="fas fa-check-circle" style="color:#00ff88; margin-right:10px;"></i> Te-ai conectat la panel cu succes.</p>
                        <p style="margin-top:10px;"><i class="fas fa-server" style="color:#3498db; margin-right:10px;"></i> Sincronizare cu Roblox DataStore...</p>
                        <p id="debug-msg" style="color: #666; font-size: 12px; margin-top: 10px;">(Status conectare va apƒÉrea aici)</p>
                    </div>
                </div>
            </div>

            <div id="page-profile" class="page-section">
                <div class="profile-header-card">
                    <img src="" id="prof-big-avatar" class="big-avatar">
                    <div class="profile-name" id="prof-name">Jucator</div>
                    <div class="profile-status"><span class="status-dot"></span> Online pe Panel</div>
                    <div class="badges-container">
                        <span class="badge badge-vip"><i class="fas fa-crown"></i> VIP</span>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="card"><i class="fas fa-wallet"></i><h3>Bani Cash</h3><p id="dash-cash">$0</p></div>
                    <div class="card"><i class="fas fa-university"></i><h3>Bani BancƒÉ</h3><p id="dash-bank">$0</p></div>
                    <div class="card"><i class="fas fa-briefcase"></i><h3>Job</h3><p id="dash-job">N/A</p></div>
                    <div class="card"><i class="fas fa-clock"></i><h3>Ore Jucate</h3><p id="dash-hours">0</p></div>
                </div>

                <div class="profile-layout">
                    <div class="profile-main" style="width: 100%;">
                        <div class="profile-tabs">
                            <div class="tab-btn" onclick="navigateTo('/profile/general')"><i class="fas fa-user"></i> General</div>
                            <div class="tab-btn" onclick="navigateTo('/profile/properties')"><i class="fas fa-home"></i> Properties</div>
                            <div class="tab-btn"><i class="fas fa-dumbbell"></i> Skills</div>
                            <div class="tab-btn"><i class="fas fa-history"></i> Faction History</div>
                        </div>

                        <div id="tab-general" class="tab-content">
                            <div class="panel-card" style="background:#1f1f1f; padding: 25px; border-radius:12px; border:1px solid #2a2a2a;">
                                <div class="data-row"><span class="data-label">Faction</span><span class="data-value" id="prof-faction" style="color:#3498db">Civilian</span></div>
                                <div class="data-row"><span class="data-label">Rank</span><span class="data-value" id="prof-rank">0</span></div>
                                <div class="data-row"><span class="data-label">Level</span><span class="data-value" id="prof-level">1</span></div>
                                <div class="data-row"><span class="data-label">Respect Points</span><span class="data-value" id="prof-rp">0</span></div>
                                <div class="data-row"><span class="data-label">Phone</span><span class="data-value" id="prof-phone">000-0000</span></div>
                                <div class="data-row"><span class="data-label">Last Online</span><span class="data-value" id="prof-seen">Necunoscut</span></div>
                            </div>
                        </div>

                        <div id="tab-properties" class="tab-content">
                            <div class="panel-card" style="background:#1f1f1f; padding: 25px; border-radius:12px; border:1px solid #2a2a2a; margin-bottom:20px;">
                                <h4 style="color:#fff; margin-bottom:10px;"><i class="fas fa-home"></i> Locuin»õƒÉ</h4>
                                <div class="data-row"><span class="data-label">CasƒÉ De»õinutƒÉ (ID)</span><span class="data-value" id="prop-house">0</span></div>
                                <div class="data-row"><span class="data-label">Sloturi Garaj</span><span class="data-value" id="prop-slots">2</span></div>
                            </div>
                            <div class="panel-card" style="background:#1f1f1f; padding: 25px; border-radius:12px; border:1px solid #2a2a2a;">
                                <h4 style="color:#fff; margin-bottom:10px;"><i class="fas fa-car"></i> Vehicule Personale</h4>
                                <table class="vehicles-table">
                                    <thead><tr><th>Model</th><th>Nume</th><th>Culoare</th><th>KM</th><th>Status</th></tr></thead>
                                    <tbody id="garage-list"><tr><td colspan="5" style="text-align:center; color:#666;">Se √ÆncarcƒÉ...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getDatabase, ref, set, get, child, update, onValue } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDwD_aL4yioTc16MOCxz7cVec_eSKfABlo",
            authDomain: "projsmprobl.firebaseapp.com",
            databaseURL: "https://projsmprobl-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "projsmprobl",
            storageBucket: "projsmprobl.firebasestorage.app",
            messagingSenderId: "1024885479778",
            appId: "1:1024885479778:web:3ae2eab4fe383b76e8b43b",
            measurementId: "G-MNHTTG5XBB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let userStatsListener = null;

        // --- DEFINIM TOAST (ADAUGAT) ---
        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
            background: '#1a1a1a', color: '#fff'
        });

        // --- SISTEM ROUTING (URL) ---
        window.navigateTo = function(path) {
            window.history.pushState({}, "", path);
            handleRoute();
        }

        window.onpopstate = handleRoute; // Cand da Back in browser

        function handleRoute() {
            const path = window.location.pathname;
            const loading = document.getElementById('loading-screen');
            const authDiv = document.getElementById('auth-container');
            const dashDiv = document.getElementById('dashboard-container');

            // Ascundem tot initial (pentru a evita flicker in interiorul paginii)
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active-page'));
            document.querySelectorAll('.sidebar li').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active-tab-content'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active-tab'));

            // Logica
            if(path === '/' || path === '/dashboard') {
                document.getElementById('page-dashboard').classList.add('active-page');
                document.getElementById('nav-dashboard').classList.add('active');
                document.getElementById('page-title').innerText = 'Dashboard';
            } 
            else if (path.includes('/profile')) {
                document.getElementById('page-profile').classList.add('active-page');
                document.getElementById('nav-profile').classList.add('active');
                document.getElementById('page-title').innerText = 'Profilul Meu';

                // Sub-rute pentru tab-uri
                const btns = document.querySelectorAll('.tab-btn');
                if(path.includes('/properties')) {
                    document.getElementById('tab-properties').classList.add('active-tab-content');
                    btns[1].classList.add('active-tab');
                } else {
                    document.getElementById('tab-general').classList.add('active-tab-content');
                    btns[0].classList.add('active-tab');
                }
            } else {
                // 404 sau default -> Dashboard
                window.history.replaceState({}, "", "/dashboard");
                handleRoute();
                return;
            }
        }

        // --- AUTH & DATA ---
        onAuthStateChanged(auth, (user) => {
            const loading = document.getElementById('loading-screen');
            const authDiv = document.getElementById('auth-container');
            const dashDiv = document.getElementById('dashboard-container');

            if (user) {
                // Logat
                authDiv.style.display = 'none';
                dashDiv.style.display = 'flex';
                
                // Verificam status cont
                const userRef = ref(db, 'site_users/' + user.uid);
                onValue(userRef, (snapshot) => {
                    loading.style.display = 'none'; // Ascundem loaderul doar cand avem date
                    const siteData = snapshot.val();
                    if(!siteData) return;

                    if (siteData.verified === false || siteData.verified === undefined) {
                        document.getElementById('verify-overlay').style.display = 'flex';
                        document.getElementById('verify-name').innerText = siteData.robloxUsername;
                        gasesteCodulUserului(user.uid);
                    } else {
                        document.getElementById('verify-overlay').style.display = 'none';
                        ascultaDateJoc(siteData.robloxUsername);
                    }
                });
                
                // Initiem ruta curenta
                handleRoute();

            } else {
                // Nelogat
                loading.style.display = 'none';
                authDiv.style.display = 'flex';
                dashDiv.style.display = 'none';
                if(userStatsListener) userStatsListener();
            }
        });

        // --- RESTUL FUNCTIILOR ---
        async function gasesteCodulUserului(uid) {
            const snap = await get(ref(db, 'verification_codes'));
            let gasit = false;
            snap.forEach(child => {
                if(child.val().uid === uid) {
                    document.getElementById('verification-code').innerText = "/link " + child.key;
                    gasit = true;
                }
            });
            if(!gasit) document.getElementById('verification-code').innerText = "LIPSA COD";
        }

        function ascultaDateJoc(numeRoblox) {
            if(userStatsListener) userStatsListener();
            userStatsListener = onValue(ref(db, `users/${numeRoblox}`), (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // Update Stats
                    document.getElementById('dash-cash').innerText = "$" + (data.banii_cash || 0).toLocaleString();
                    document.getElementById('dash-bank').innerText = "$" + (data.banii_banca || 0).toLocaleString();
                    document.getElementById('dash-job').innerText = data.job_curent || "N/A";
                    document.getElementById('dash-hours').innerText = data.ore_jucate || 0;
                    if(data.avatar_url) {
                        document.getElementById('miniAvatar').src = data.avatar_url;
                        document.getElementById('prof-big-avatar').src = data.avatar_url;
                    }
                    document.getElementById('prof-name').innerText = numeRoblox;
                    document.getElementById('prof-level').innerText = data.level || 1;
                    document.getElementById('prof-rp').innerText = data.rp || 0;
                    document.getElementById('prof-faction').innerText = data.factiune || "Civil";
                    document.getElementById('prof-rank').innerText = data.rank || 0;
                    document.getElementById('prof-phone').innerText = data.telefon || "N/A";
                    document.getElementById('prof-seen').innerText = data.last_online || "N/A";
                    document.getElementById('prop-house').innerText = (data.casa_detinuta && data.casa_detinuta > 0) ? "ID " + data.casa_detinuta : "FƒÉrƒÉ CasƒÉ";
                    document.getElementById('prop-slots').innerText = data.sloturi_garaj || 2;

                    const garageList = document.getElementById('garage-list');
                    garageList.innerHTML = ""; 
                    if (data.masini && Array.isArray(data.masini) && data.masini.length > 0) {
                        data.masini.forEach(car => {
                            const row = document.createElement('tr');
                            const statusColor = (car.status === "Spawned" || car.status === "Stored") ? "vehicle-status-ok" : "vehicle-status-broken";
                            row.innerHTML = `<td>${car.model}</td><td>${car.nume}</td><td>${car.culoare}</td><td>${car.km} km</td><td class="${statusColor}">${car.status}</td>`;
                            garageList.appendChild(row);
                        });
                    } else {
                        garageList.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px; color:#555;'>Niciun vehicul √Æn garaj.</td></tr>";
                    }
                }
            });
        }

        window.toggleForms = () => {
            const login = document.getElementById('login-form');
            const reg = document.getElementById('register-form');
            login.style.display = login.style.display === 'none' ? 'block' : 'none';
            reg.style.display = reg.style.display === 'none' ? 'block' : 'none';
        }

        window.registerUser = async () => {
            const robloxName = document.getElementById('reg-roblox').value.trim();
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            
            // MODIFICAT: SweetAlert in loc de alert
            if(!robloxName || !email || !pass) return Toast.fire({ icon: 'warning', title: 'CompleteazƒÉ tot!' });
            
            const randomCode = Math.floor(1000 + Math.random() * 9000).toString();
            try {
                const uc = await createUserWithEmailAndPassword(auth, email, pass);
                await set(ref(db, 'site_users/' + uc.user.uid), { robloxUsername: robloxName, email: email, verified: false });
                await set(ref(db, 'verification_codes/' + randomCode), { uid: uc.user.uid, robloxName: robloxName });
                
                // MODIFICAT: SweetAlert Success
                Swal.fire({
                    icon: 'success',
                    title: 'Cont creat!',
                    text: 'Te-ai √Ænregistrat cu succes. Acum te po»õi loga.',
                    confirmButtonText: 'Perfect'
                });

                toggleForms();
            } catch(e) { 
                // MODIFICAT: SweetAlert Error
                Swal.fire({ icon: 'error', title: 'Eroare √énregistrare', text: e.message }); 
            }
        }

        window.loginUser = () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            
            // MODIFICAT: SweetAlert in loc de alert
            if(!email || !pass) return Toast.fire({ icon: 'warning', title: 'CompleteazƒÉ tot!' });

            signInWithEmailAndPassword(auth, email, pass)
                .then(() => {
                     Toast.fire({ icon: 'success', title: 'Te-ai logat cu succes!' });
                })
                .catch(e => {
                    Swal.fire({ icon: 'error', title: 'Eroare Login', text: e.message });
                });
        }
        
        window.logoutUser = () => signOut(auth).then(() => { 
            // Putem adauga un mic toast inainte de refresh daca se doreste, dar refresh-ul e rapid
            window.history.pushState({}, "", "/"); 
            location.reload() 
        });

        window.activeazaVerificarea = async function() {
            if(!auth.currentUser) return;
            const snapshot = await get(ref(db, 'site_users/' + auth.currentUser.uid));
            const siteData = snapshot.val();
            if(siteData) {
                const randomCode = Math.floor(1000 + Math.random() * 9000).toString();
                await update(ref(db, 'site_users/' + auth.currentUser.uid), { verified: false });
                await set(ref(db, 'verification_codes/' + randomCode), { uid: auth.currentUser.uid, robloxName: siteData.robloxUsername });
                document.getElementById('verification-code').innerText = "/link " + randomCode;
                Toast.fire({ icon: 'info', title: 'Cod nou generat!' });
            }
        }
        window.cautaJucatorManual = function() {
            const nume = document.getElementById('searchInput').value;
            if(nume) ascultaDateJoc(nume);
        }
    </script>
</body>
</html>
